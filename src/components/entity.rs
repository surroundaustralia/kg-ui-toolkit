use implicit_clone::unsync::IString;
use yew::prelude::*;

use crate::{
    components::{onclick_anchor_handler, GenericProperties, ProvenanceLinks},
    models,
};

pub enum Message {
    ActivityClicked(IString),
    AgentClicked(IString),
    EntityClicked(IString),
}

#[derive(Properties, PartialEq)]
pub struct Props {
    pub entity: models::Entity,
    #[prop_or_default]
    pub on_activity_click: Option<Callback<IString>>,
    #[prop_or_default]
    pub on_agent_click: Option<Callback<IString>>,
    #[prop_or_default]
    pub on_entity_click: Option<Callback<IString>>,
}

pub struct Entity;

impl Component for Entity {
    type Message = Message;

    type Properties = Props;

    fn create(_ctx: &Context<Self>) -> Self {
        Self
    }

    fn update(&mut self, ctx: &Context<Self>, msg: Self::Message) -> bool {
        match msg {
            Message::ActivityClicked(activity_id) => {
                if let Some(on_activity_click) = &ctx.props().on_activity_click {
                    on_activity_click.emit(activity_id);
                }
                false
            }
            Message::AgentClicked(agent_id) => {
                if let Some(on_agent_click) = &ctx.props().on_agent_click {
                    on_agent_click.emit(agent_id);
                }
                false
            }
            Message::EntityClicked(entity_id) => {
                if let Some(on_entity_click) = &ctx.props().on_entity_click {
                    on_entity_click.emit(entity_id);
                }
                false
            }
        }
    }

    fn view(&self, ctx: &Context<Self>) -> Html {
        html! {
            <form>
                <fieldset>
                    <legend>{format!("Entity: {}", ctx.props().entity.label.clone().unwrap_or(AttrValue::from("<unknown>")))}</legend>
                    <GenericProperties properties={ctx.props().entity.properties.clone()} />
                    <ProvenanceLinks id_prefix="was-attributed-to" label="Attributed to" links={ctx.props().entity.was_attributed_to.clone()} onclick={onclick_anchor_handler(ctx.link(), Message::AgentClicked)} />
                    <ProvenanceLinks id_prefix="was-derived-from" label="Derived from" links={ctx.props().entity.was_derived_from.clone()} onclick={onclick_anchor_handler(ctx.link(), Message::EntityClicked)} />
                    <ProvenanceLinks id_prefix="was-generated-by" label="Generated by" links={ctx.props().entity.was_generated_by.clone()} onclick={onclick_anchor_handler(ctx.link(), Message::ActivityClicked)} />
                </fieldset>
            </form>
        }
    }
}
